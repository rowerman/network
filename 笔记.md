## 一.概述

### 1.1 计算机网络在信息时代中的作用

![image-20231224150000992](network/main/图图\image-20231224150000992.png)

### 1.2 互联网概述

* 计算机网络：由若干节点和连接这些节点的链路组成，节点可以是计算机、集线器、交换机或路由器等
* 互连网：多个网络通过一些路由器相互连接起来，构成了一个覆盖范围更大的计算机网络

### 1.3 互联网的组成

![image-20231224150303669](E:\Markdown\计网\图图\image-20231224150303669.png)

#### 1.3.1 互联网的边缘部分

处于互联网边缘部分的就是连接在互联网上的所有主机，这些主机又称为端系统。

端系统之间的通信可以是C/S、P2P

* C/S通信方式：客户/服务器方式所描述的是进程之间服务和被服务的关系
* P2P（对等连接方式）：两台主机在通信时不区分服务请求方和服务提供方

#### 1.3.2 互联网的核心部分

**分组转发**是网络核心部分最重要的功能。互联网的核心部分采用**分组交换技术**

* 电路交换：两两直接相连，电线对的数量与电话机数量的平方成正比

![image-20231224151003937](E:\Markdown\计网\图图\image-20231224151003937.png)

* 报文交换：早期用于电报，数据的传输不需要建立连接，数据的传输是一站一站往下送，所以数据中必须包含目的地址，并采用**存储-转发**机制

  每个中间站点必须有**足够大的缓存**，报文交换不适用于实时性要求高的业务

* 分组交换：采用**存储转发技术**

![image-20231224151216656](E:\Markdown\计网\图图\image-20231224151216656.png)

![image-20231224151339678](E:\Markdown\计网\图图\image-20231224151339678.png)

**三种方式对比**：

* 若要连续传送大量的数据，且其传送时间远大于连接建立时间，则电路交换的传输速率较快
* 报文交换和分组交换不需要预先分配传输带宽，在传送突发数据时可以提高整个网络的信道利用率
* 由于一个分组的长度往往远小于整个报文的长度，因此分组交换比报文交换的时延小，同时也具有更好的灵活性

### 1.4 计算机网络在我国的发展

略

### 1.5 计算机网络的类别

**按网络的作用范围进行分类**：

* 广域网（WAN）：通常为几十到几千公里，有时也称为远程网
* 城域网（MAN）：作用范围一般是一个城市
* 局域网（LAN）：局限在较小的范围中
* 个人局域网（PAN）：范围很小，有时也称为无线个人局域网

### 1.6 计算机网络的性能

#### 1.6.1 速率

指的是数据的传输速率，也成为数据率或比特率。速率往往是指额定速率或标称速率，并非实际运行速率（注意两种换算单位）

#### 1.6.2 带宽

![image-20231224152149165](E:\Markdown\计网\图图\image-20231224152149165.png)



#### 1.6.3 吞吐量

单位时间内通过某个网络的**实际数据量**，受网络的带宽或网络额定速率的限制，有时可用每秒传送的字节数或帧数来表示

#### 1.6.4 时延

指数据从网络的一端传送到另一端所需的时间，由四部分组成：

* 发送时延（**传输时延**）：是主机或路由器发送数据帧所需要的时间，也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间

$$
\text{发送时延}=\frac{数据帧长度(bit)}{发送速率(bit/s)}
$$

* 传播时延：

$$
\text{传播时延}=\frac{信道长度}{信号在信道上的传播速率}
$$

* 处理时延：主机或路由器在收到分组时，为处理分组所花费的时间
* 排队时延：分组在路由器输入输出队列中排队等待处理和转发所经历的时延![image-20231224152747383](E:\Markdown\计网\图图\image-20231224152747383.png)

**容易产生的错误概念**：在高速链路上，bit会传送的更快些

对于高速网络链路，我们提高的仅仅是数据的发送速率，而不是比特在来链路上的传播速率，提高数据的发送速率只是减小了数据的发送时延

#### 1.6.5 带宽时延积

链路的带宽时延积，又称为以比特为单位的链路长度

![image-20231224153052997](E:\Markdown\计网\图图\image-20231224153052997.png)

#### 1.6.6 往返时间RTT

![image-20231224153141069](E:\Markdown\计网\图图\image-20231224153141069.png)

#### 1.6.7 利用率

* 信道利用率：某信道有百分之几的时间是被利用的（有数据通过），完全空闲的信道的利用率是0
* 网络利用率：全网络的信道利用率的加权平均值

信道利用率并不是越高越好

### 1.7 计算机网络的体系结构

网络的体系结构是计算机网络的各层级其协议的集合，就是这个计算机网络及其构件所应完成的功能的精确定义

![image-20231224153443748](E:\Markdown\计网\图图\image-20231224153443748.png)

* OSI参考模型把对等层之间传送的数据单位称为该层的协议数据单元PDU，任何两个同样的层次把PDU通过水平虚线直接传递给对方，这就是所谓的”对等层“之间的通信

* 服务访问点：在同一系统中相邻两层的实体进行交互的地方

![image-20231224153746352](E:\Markdown\计网\图图\image-20231224153746352.png)

## 二.物理层

### 2.1 物理层的基本概念

物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层协议也称为物理层**规程**，可以将物理层的主要任务描述为确定与传输媒体的接口有关的一些特性：

* 机械特性
* 电气特性
* 功能特性
* 过程特性

### 2.2 数据通信的基础知识

数据通信系统主要由三大部分组成：源系统、传输系统和目的系统

#### 2.2.1 有关信道的几个基本概念

**信道的分类**：

* 单工通信：单向通信，只能有一个方向的通信，没有反方向的交互
* 半双工通信：双向交替通信，通信的双方都可以发送信息，但双方**不能同时**发送

* 全双工通信：双向同时通信，通信的双方可以同时发送和接收信息

**信号调制**：

* 基带调制：仅对基带信号的波形进行变换，将数字信号转换为另一种形式的数字信号
* 带通调制：使用载波进行调制，将基带信号的频率范围搬移到较高的频段，并转换为模拟信号。经过载波调制后的信号称为带通信号

**常用编码方式**：

（1）曼彻斯特编码和差分曼彻斯特编码产生的信号频率比不归零制高

（2）自同步能力：不归零制不能从信号波形本身中提取信号时钟频率，即没有自同步能力

* 不归零制：正电平代表1，负电平代表0
* 归零制：正脉冲代表1，负脉冲代表0
* 曼彻斯特编码：为周期中心的向上跳变代表0，位周期中心的向下跳变代表1
* 差分曼彻斯特编码：在每一位的中心处始终都有跳变；位开始边界有跳变代表0，而位开始边界没有跳变代表1

**基本的带通调制方法**：为了达到更高的信息传输速率，可以采取**正交振幅调制**

* 调幅（AM）：载波的振幅随基带数字信号而变化
* 调频（FM）：载波的频率随基带数字信号而变化
* 调相（PM）：载波的初始相位随基带数字信号而变化

#### 2.2.2 信道的极限容量

限制码元在信道上的传输速率的因素有以下两个：

（1）信道能够通过的频率范围

信号中的许多高频分量往往不能通过信道，这就会导致**码间串扰**：接收端收到的信道波形失去了码元之间的清晰界限

**奈氏准则**：在带宽为$W$(Hz)的低通信道中，若不考虑噪声影响，则码元传输的最高速率是$2W$(码元/秒)。若传输速率超过此上限，就会出现严重的码间串扰的问题，使接收端对码元的判决成为不可能

（2）信噪比

信噪比：信号的平均功率和噪声的平均功率之比，用分贝(dB)作为度量单位，即：
$$
\text{信噪比}(dB)=10log_{10}(S/N)
$$
香农公式：信道的极限信息传输速率C可表达为：
$$
C=Wlog_2(1+S/N)
$$
其中，W为信号的带宽，S为信道内所传信号的平均功率，N为信道内部的高斯噪声功率

**提高信息传输速率的方法**：用编码的方法让每一个码元携带更多bit的信息量

### 2.3 物理层下面的传输媒体

传输媒体也成为传输介质或传输媒介，可分为两大类：**导引型传输媒体**和**非导引型传输媒体**

#### 2.3.1 导引型传输媒体

（1）双绞线：最古老但最常用的传输媒体，将两根互相绝缘的铜导线并排放在一起，然后用规则的方法**绞合**起来就构成了双绞线。绞合度越高，可用的数据传输率越高

* 无屏蔽双绞线UTP
* 屏蔽双绞线STP

（2）同轴电缆：具有很好的抗干扰特性，被广泛用于传输较高速率的数据

（3）光缆：

光纤是光纤通信的传输媒体，通过传递光脉冲来进行通信。发送端要有光源，接收端要有光检测器

* 多模光纤：可以存在多条不同角度入社的光线在一条光纤中传输。光脉冲在多模光纤中传输时会逐渐展宽，只适合于近距离传输
* 单模光纤：其直径减小到只有一个光的波长（几微米），可使光线一直向前传播，而不会产生多次反射

光缆是由一至多根光纤组织而成

#### 2.3.2 非导引型传输媒体

（1）无线电传输：全方向传播，主要靠电离层的反射，具有多径效应——通信质量较差

![image-20231220214348795](E:\Markdown\计网\图图\image-20231220214348795.png)

（2）微波传输：直线传播，能穿透电离层

（3）光波传输：

![image-20231220214424750](E:\Markdown\计网\图图\image-20231220214424750.png)

### 2.4 信道复用技术

#### 2.4.1 频分复用、时分复用和统计时分复用

（1）频分复用FDM：各路信号在同样的时间占用不同的带宽资源（这里的带宽指频率带宽）

（2）时分复用TDM：将时间划分为一段段等长的时分复用帧，每一个时分复用的用户在每一个TDM帧中占用固定序号的时隙。每一个用户所占用的时隙是周期性出现的，TDM信号也称为等时信号。**时分复用会导致信道利用率不高**

（3）统计时分复用STDM：

![image-20231220215608141](E:\Markdown\计网\图图\image-20231220215608141.png)

（4）频分多址：可让N个用户各使用一个频带，或让更多的用户轮流使用这N个频带，这种方式称为**频分多址接入FDMA**，简称为频分多址

（5）时分多址：可让N个用户各使用一个时隙，或让更多的用户轮流使用这N个时隙，这种方式称为**时分多址接入TDMA**，简称为时分多址

#### 2.4.2 波分复用

波分复用WDM：光的频分复用，使用一根光纤来同时传输多个光载波信号

#### 2.4.3 码分复用

常用的名词是码分多址CDMA，各用户在相同的时间使用相同的频带——各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰

![image-20231220220205468](E:\Markdown\计网\图图\image-20231220220205468.png)

![image-20231220220332551](E:\Markdown\计网\图图\image-20231220220332551.png)



![image-20231220220348979](E:\Markdown\计网\图图\image-20231220220348979.png)

码片序列实现了扩频：要发送信息的数据率=b bit/s，实际发送的数据率=mb bit/s，同时所占用的频带宽度也提高到原来的m倍。扩频通常有两类：

* 直接序列扩频DSSS
* 跳频扩频FHSS

### 2.5 数字传输系统

![image-20231220220658012](E:\Markdown\计网\图图\image-20231220220658012.png)

### 2.6 宽带接入技术

![image-20231220220815039](E:\Markdown\计网\图图\image-20231220220815039.png)

接入网可分为以下几种：

* 数字用户线DSL
* 同轴电缆
* 光纤到户FTTH
* 无线接入

## 三. 数据链路层

### 3.1 数据链路层概述

#### 3.1.1 数据链路和帧

* 链路（物理链路）：是一段无源的点到点的物理连接，中间没有任何交换节点（有线或无线）
* 数据链路：链路+为实现数据传输而在两端配置的硬件+相关的通信协议

服务可分为三大类：

* 无确认，无连接服务：以太网
* 有确认，无连接服务：802.11
* 有确认，有连接服务

数据链路层要实现三类控制：

* 差错控制
* 流量控制
* 介质接入控制

### 3.2 使用点对点信道的数据链路层

#### 3.2.1 封装成帧

在一段数据的前后分别添加首部和尾部进行**帧定界**，每一种数据链路层协议都规定了所能传输的帧的**数据部分长度上限**：最大传送单元MTU

![image-20231121140317066](E:\Markdown\计网\图图\image-20231121140317066.png)



**带字符填充的起始字符和终结字符法**：用控制字符作为帧定界符，这是一种面向字符的帧格式

* 控制字符SOH放在一帧的最前面，表示帧的首部的开始
* 控制字符EOT放在一帧的末尾，表示帧的结束

#### 3.2.2 透明传输

在数据链路层透明传输数据表示：无论发送什么样的比特组合的数据，这些数据都能够按照原样**没有差错**地通过这个数据链路层

实现透明传输的两种方法：

* 字符填充：在控制字符SOH或EOT前面插入一个转义字符ESC，如果转义字符也在数据中出现，那就在转义字符前面再插入一个转义字符
* 位填充：由于这种标志法以特殊的位模式**01111110**作为帧标志，所以在输入数据中连续5个1后自动插入一个0

#### 3.2.3 差错检测

比特差错：比特在传输过程中会存在翻转的可能性，比特差错是传输差错的一种

传输差错：除了比特差错外还有帧丢失、帧重复、帧失序等

误码率：一段时间内，传输错误的比特占所有传输比特总数的比率

循环冗余校验CRC：是一种校验的方法。再发送端先将数据划分为组，每组k个bit，CRC运算在每组M后面再添加n位冗余码，然后构成一个帧发送出去，一共发送k+n位

![image-20231121141427965](E:\Markdown\计网\图图\image-20231121141427965.png)

* 在M后面添加n个0
* 用得到的k+n位的数除以事先选定好的长度为n+1位的除数P，得出商是Q，余数是R（n位）
* 将余数R作为冗余码拼接在数据M后面，一起发送出去，这个冗余码称为**帧检验序列FCS**

![image-20231121141656596](E:\Markdown\计网\图图\image-20231121141656596.png)

若数据链路层仅仅使用CRC差错检测技术，则只能做到对帧的无差错接受，即凡是接收端数据链路层接受的帧均无差错

### 3.3 点对点协议PPP

PPP协议有三个组成部分：

* 一个将IP数据报封装到串行链路的方法
* 一个链路控制协议LCP
* 一套网络控制协议NCP

#### 3.3.1 PPP协议的帧格式

![image-20231121142312288](E:\Markdown\计网\图图\image-20231121142312288.png)

**透明传输问题**：

当PPP使用异步传输时，使用字节填充法，转移字符定义为0x7D

* 把信息字段中每一个0x7E字节转变为2字节序列（0x7D,0x5E）
* 把信息字段中出现的每一个0x7D字节转变为2字节序列（0x7D,0x5D）
* 若信息字段中出现数值小于0x20的字符，则要在字符前加入一个0x7D字节，并将字符的编码改变，如把0x03变为（0x7D,0x23）

当PPP使用同步传输时，使用零比特填充法，即连续的5个1后填充一个0

#### 3.3.2 PPP协议的工作状态

PPP链路初始化过程：

* 用户拨号接入ISP后，就建立了一条从用户个人电脑到ISP的**物理连接**
* 用户电脑向ISP发送一系列的**链路控制协议LCP分组**（封装成多个PPP帧），以便建立**LCP连接**

* 之后进行网络层配置，**网络控制协议NCP**给新接入的用户个人电脑分配一个临时的IP地址
* 当用户通信完毕时，NCP释放网络层链接，收回分配出去的IP地址。LCP释放数据链路层连接，最后释放的是物理层的连接

![image-20231121143244665](E:\Markdown\计网\图图\image-20231121143244665.png)

### 3.4 使用广播信道的数据链路层

需要注意的是，局域网包括：**物理层**和**数据链路层**

我们讨论的以太网采用的是动态媒体介入控制中的随机接入方法

#### 3.4.1 以太网的两个标准

* DIX Ethernet V2
* IEEE 802.3

这两种标准的硬件实现可以在同一个局域网上互操作。严格来说，目前的以太网应该是指符合DIX Ethernet V2标准的局域网。

IEEE 802.3将数据链曾拆成了逻辑链路控制LLC子层和媒体介入控制MAC子层，现在大多数适配器上都没有LLC子层的协议了

![image-20231121143824438](E:\Markdown\计网\图图\image-20231121143824438.png)

#### 3.4.2 适配器的作用

![image-20231121144030531](E:\Markdown\计网\图图\image-20231121144030531.png)

#### 3.4.3 CSMA/CD协议

为了通信的简便，以太网采取了两种措施：

* 无连接的工作方式：不必先建立连接就可以直接发送数据；对发送的数据帧不进行编号，也不要求对方发回确认。因此以太网提供的服务是**尽最大努力的交付**，它会丢弃所有有差错的帧，而是否需要重传该帧由高层决定
* 发送的数据采用曼彻斯特编码：可以从收到的比特流中提取位同步信号，但所占的频带宽度也比原始的基带信号增加了一倍

**CSMA/CD协议的特点**：

* 多点接入：各个站共享信道
* 载波监听：无论在想要发送数据之前，还是在发送数据之后，每个站都必须不停地检测信道
* 碰撞检测：适配器在发送数据的同时会检测信道上信号电压的变化，若电压摆动值超过一定的阈值，说明发生了碰撞

![image-20231121145301731](E:\Markdown\计网\图图\image-20231121145301731.png)

争用期：以太网的端到端往返时延$2 \tau$称为争用期或碰撞窗口，具体的争用期时间为512$\mu s$

**碰撞后重传**：

![image-20231121145713250](E:\Markdown\计网\图图\image-20231121145713250.png)

对于10Mbit/s的以太网，在争用期内可发送512bit，即64字节。这意味着，以太网在发送数据时，若前64字节没有发生冲突，则后续的数据就不会发生冲突。

以太网规定了最短有效帧长为64字节，长度小于64字节的帧都是由于冲突而异常中止的无效帧，应当立即将其丢弃

**强化碰撞**：当发送数据的站一旦发现发生了碰撞之后，除了立即停止发送数据外，还要再继续发送32bit或48bit的人为干扰信号

以太网还规定了帧间最小间隔为9.6$\mu s$，相当于96bit时间，这样做是为了使刚收到数据帧的站接收缓存来得及清理

总结CSMA/CD协议的要点：

![image-20231121150701110](E:\Markdown\计网\图图\image-20231121150701110.png)

#### 3.4.4 使用集线器的星形拓扑

传统的以太网使用同轴电缆，采用总线形拓扑结构；而使用双绞线的以太网采用星形拓扑

![image-20231121151126260](E:\Markdown\计网\图图\image-20231121151126260.png)

集线器的特点：

* 使用电子器件来模拟电缆线的工作，所以整个系统仍像一个传统的以太网那样运行
* 使用集线器的以太网在逻辑上仍是一个总线网
* 集线器工作在物理层，它的端口仅仅简单地转发比特，不进行碰撞检测
* 采用了专门的芯片

#### 3.4.5 以太网的信道利用率

信道利用率S=有效的数据发送时间/传输过程总时间，争用信道和空闲信道的利用率为0

以太网总的信道利用率并不能达到100%

![image-20231121151513497](E:\Markdown\计网\图图\image-20231121151513497.png)

在以太网中定义参数$a=\tau / T_0$，要提高以太网的信道利用率，就必须减少$\tau $与$T_0$之比
$$
S= \frac{1}{n \times 2\alpha +1+ \alpha}
$$
当$\alpha \rightarrow 0$时，表示易发生碰撞就立即可以检测出来，并立即停止发送，因而信道利用率很高

所以，当数据率一定时，以太网连线的长度受到限制，同时以太网的帧长不能太短

#### 3.4.6 以太网的MAC地址

在局域网中，硬件地址又称为物理地址或MAC地址，IEEE 802标准为局域网规定了一种48位的全球地址，这就是局域网上的每一台计算机固化在适配器的ROM中的地址

目前IEEE注册管理机构负责向厂家发放地址字段的6个字节中的前3个字节。称为**组织唯一标识符OUI**，厂家自行指派后三个字节，称为**扩展标识符**

IEEE规定地址字段的第1字节的最低位为I/G位

* 单播地址：I/G位=0
* 组地址（多播地址）：I/G位=1
* 广播地址：全1

全球管理与本地管理，IEEE将地址字段的第1字节二的最低第2位规定为G/L位：

* 全球管理：G/L位=0
* 本地管理：G/L位=1，用户可以任意分配网络上的地址

**适配器具有过滤功能**：

![image-20231121153117216](E:\Markdown\计网\图图\image-20231121153117216.png)

**MAC帧的格式**：

![image-20231121153257952](E:\Markdown\计网\图图\image-20231121153257952.png)

其中，类型字段标识了网络层使用的协议类型，数据字段的最小46字节是由最小帧长64字节减去首尾18字节得到的。值得注意的是，FCS检验的范围是**整个MAC帧**。即从目的地址开始到FCS为止的这五个字段

在MAC帧的前面要插入7个字节的前同步码使接收端的适配器能够迅速调整其时钟频率，使它和发送端的时钟同步；还有一个字节的帧开始定界符，前6位和前同步码一样，最后连续的两个1告诉接收端适配器数据要来了

* 如何从以太网帧中取出正确数据字节数：借助曼彻斯特编码的特点，当发送方网络适配器的接口上的电压不再变化时，接收方可以很容易地找到以太网帧的结束位置。在这个结束位置往前数4字节就能确定数据字段的结束位置
* 如何判断数据部分是否填充了0：根据IIP数据报的总长度计算

### 3.5 扩展的以太网

#### 3.5.1 在物理层扩展以太网

* 使用光纤扩展
* 使用集线器扩展：会使得多个碰撞域合并为一个碰撞域，而且总的吞吐量未提高；且如果使用不同的以太网技术（如数据率不同），那就不能用集线器将它们互连起来

#### 3.5.2 在数据链路层扩展以太网

早期使用网桥，现在更多的使用交换机

![image-20231121154458259](E:\Markdown\计网\图图\image-20231121154458259.png)

以太网交换机的特点：

* 实质上是一个多接口网桥
* 每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般都工作在**全双工**方式
* 以太网交换机具有**并行性**
  * 能同时连通多对接口，使多对主机能同时通信
  * 相互通信的主机都独占传输媒体，无碰撞地传输数据
  * 每一个端口和连接到端口的主机构成了一个碰撞域

![image-20231121154746727](E:\Markdown\计网\图图\image-20231121154746727.png)

![image-20231121154847831](E:\Markdown\计网\图图\image-20231121154847831.png)

**交换机为每个端口提供带宽B，如果有N个用户，则每个用户独占带宽B，交换机的总容量达B*N**

以太网交换机的交换方式：

* 存储转发方式
* 直通方式

**交换机的学习功能**：

![image-20231121155146448](E:\Markdown\计网\图图\image-20231121155146448.png)

但在使用以太网交换机时，一些冗余的链路可能会导致以太网帧在某个环路中无限制的循环。为了解决这种问题，IEEE标准制定了一个**生成树协议STP**，保证一台主机到所有其他主机的路径是无环路的树状结构

**从总线以太网到星形以太网**：

![image-20231121155644316](E:\Markdown\计网\图图\image-20231121155644316.png)

#### 3.5.3 虚拟局域网

虚拟局域网VLAN是由一些局域网网段构成的与**物理位置无关的逻辑组**。而这些网段有某些共同的需求。虚拟局域网其实只是局域网给用户提供的一种服务，并**不是**一种新型局域网

划分虚拟局域网的方法：

* 基于交换机端口：最简单、最常用，但缺点是不允许用户移动

* 基于计算机网卡的MAC地址：允许用户移动，但缺点使需要输入和管理大量的MAC地址，如果用户的MAC地址变了，则需要管理员重新配置VLAN

* 基于协议类型：根据以太网帧的第三个字段“**类型**”确定该类型的协议属于哪一个虚拟局域网
* 基于IP子网地址：根据以太网帧的第三个字段“**类型**”和IP分组首部中的“**源IP地址**”字段

* 基于高层应用或服务

虚拟局域网使用的MAC帧的格式：

![image-20231121160431812](E:\Markdown\计网\图图\image-20231121160431812.png)

插入802.1Q的时机：

![image-20231121160616838](E:\Markdown\计网\图图\image-20231121160616838.png)

### 3.6 高速以太网

* 100BASE-T以太网：又称为快速以太网，在双绞线上传送100Mbit/s基带信号的星形拓扑以太网，仍使用CSMA/CD协议；可在全双工方式下工作
* 吉比特以太网：允许在1Git/s下以全双工和半双工2种方式工作。当以**半双工方式**工作时采用CSMA/CD，需要进行碰撞检测。且新增加两个功能：载波延伸和分组突发

![image-20231121161052655](E:\Markdown\计网\图图\image-20231121161052655.png)

![image-20231121161144182](E:\Markdown\计网\图图\image-20231121161144182.png)



## 四. 网络层

### 4.1 网络层的基本概念

#### 4.1.1 网络层提供的服务

互联网的设计思路：网络层设计的尽量简单，向其上层只提供简单灵活的、**无连接的**、尽最大努力交付的**数据报服务**（这里的“数据报”实际上就是分组）

* 网络在发送分组时不需要先建立连接
* 每一个分组独立发送，与其前后的分组无关
* 网络层不提供服务质量的保证
* 由**运输层（主机）**负责可靠的通信

#### 4.1.2 网络层的两个层面

在路由器之间传送的信息有两大类：

* 数据
* 路由信息：用于创建路由表，进而导出转发表，为数据传送服务

网络层可以划分为两个层面（抽象）：

* 数据层面：路由器根据本路由器生成的转发表，把收到的分组从查找到的对应接口转发出去
  * 独立工作
  * 采用硬件进行转发，速度快
* 控制层面：根据路由选择协议计算路由，创建出本路由器的路由表
  * 许多路由器协同工作
  * 采用软件计算，速度慢

软件定义网络SDN提出了一种新的路由结构

![image-20231114190130384](E:\Markdown\计网\图图\image-20231114190130384.png)

### 4.2 网际协议IP

与网际协议IPv4配套使用的三个协议：

* 地址解析协议$ARP$
* 网际控制报文协议$ICMP$
* 网际组管理协议$IGMP$

![image-20231114190409456](E:\Markdown\计网\图图\image-20231114190409456.png)

#### 4.2.1 虚拟互联网络

将网络互联用到的**中间设备**：

* 物理层：转发器
* 数据链路层：网桥或桥接器、交换机
* 网络层：路由器
* 网络层以上：网关

![image-20231114190845652](E:\Markdown\计网\图图\image-20231114190845652.png)

**IP网的意义**：如果在这种覆盖全球的IP网上使用TCP、UDP协议，那么就是现在的互联网

#### 4.2.2 IP地址

（1）IP地址及其表示方法

![image-20231114191201447](E:\Markdown\计网\图图\image-20231114191201447.png)

![image-20231114191314155](E:\Markdown\计网\图图\image-20231114191314155.png)

（2）分类的IP地址

![image-20231114191441880](E:\Markdown\计网\图图\image-20231114191441880.png)

![image-20231114191744955](E:\Markdown\计网\图图\image-20231114191744955.png)

私有网络的IP地址：

![image-20231114192036514](E:\Markdown\计网\图图\image-20231114192036514.png)

（3）无分类编址CIDR

* 网络前缀：

![image-20231114192210336](E:\Markdown\计网\图图\image-20231114192210336.png)

* 地址块

![image-20231114192924292](E:\Markdown\计网\图图\image-20231114192924292.png)

* 地址掩码（子网掩码）

![image-20231114193240861](E:\Markdown\计网\图图\image-20231114193240861.png)

计算网络地址时将子网掩码与IP地址进行**按位与**

三个特殊的CIDR地址块：

![image-20231114193521349](E:\Markdown\计网\图图\image-20231114193521349.png)

**路由聚合**：在路由器的转发表中利用较大的一个CIDR地址块来代替许多较小的地址块

* IP地址的特点：
  * 每个IP地址都分成两部分。IP管理机构在分配IP时只需要分配网络前缀
  * IP地址标识一台主机（或路由器）和一条链路的接口
  * 用转发器或交换机连接起来的若干个局域网仍为一个网络（**网络前缀必须相同**）
  * 所有分配到网络前缀的网络都是平等的

![image-20231114194638092](E:\Markdown\计网\图图\image-20231114194638092.png)

<font color="red">注意</font>：

（1）路由器总是具有两个或两个以上的IP地址，即路由器每个接口的IP地址的网络前缀都不同

（2）当两个路由器直接相连时，在连线两端的接口处可以分配，也可以不分配IP。这段连线构成了一种特殊“网络”，这里使用了$/31$地址块

#### 4.2.3 IP地址与MAC地址

![image-20231114195108701](E:\Markdown\计网\图图\image-20231114195108701.png)

![image-20231114195133043](E:\Markdown\计网\图图\image-20231114195133043.png)

* 在IP层抽象的互联网上只能看到IP数据报，数据传输过程中IP数据报的源IP和目的IP始终不变
* 在局域网的数据链路层，只能看见MAC帧，且传输过程中目的MAC和源MAC不断变化

#### 4.2.4 地址解析协议ARP

通过ARP高速缓存实现

（1）局域网内部ARP：

* 第一步，主机A广播一个ARP请求分组，并将自己的IP和MAC附加在消息中
* 第二步，目的IP符合的主机B接收分组，并将主机A的IP地址到MAC地址的映射存入缓存。随后向主机A发送ARP响应分组，其中包含B的MAC地址
* 第三步，主机A收到B的ARP响应分组后，将B的IP地址到MAC地址的映射存入缓存

ARP高速缓存中的每一个映射项目都有一个生存时间，超过该时间的项目会从缓存中删除

（2）局域网间ARP：

* 局域网A中的主机H1将消息转发给路由器R（路由器R相当于局域网A中的一台主机，ARP缓存中有映射项目）
* 路由器R再发送给主机H2

**为什么要使用IP地址和MAC地址这两种地址？**

不同网络使用不同的MAC地址，MAC地址之间的转换非常复杂。使用IP编址可以简化问题

#### 4.2.5 IP数据报的格式

IP数据报由**首部**和**数据部分**构成

首部组成：

![image-20231119090729091](E:\Markdown\计网\图图\image-20231119090729091.png)

* 版本：占4bit，指明IP的版本，这里讨论的IP版本号为4
* 首部长度：占4bit，这里表示的单位为32bit（**4个字节**），因此首部长度字段的最小值为5（0101，对应首部长度为20个字节），最大值为15（1111，对应首部长度为60个字节）
* 区分服务：占8bit，只有使用区分服务时这个字段才起作用，一般情况下不使用
* 总长度：占16bit，这里表示的单位为**1个字节**，所以数据报的最大长度为$2^{16}-1=65535$个字节。但是IP数据报的总长度不能超过数据链路层规定的**MTU**值，否则就要进行分片处理
* 标识：占16bit，这个标识字段的值用于将分片得到的IP数据报进行汇总整合（标识相同意味着应该整合成同一个数据报）
* 标志：占3bit，但目前只有前两位有意义。
  * 标志字段的最低位为**MF**，MF=1表示后面还有分片；MF=0表示最后一个分片
  * 标志字段中间的一位是**DF**，只有当DF=0时才允许分片
* 片偏移：占13bit，用于指出较长的分组在分片后，某片在原分组中的相对位置，即相对于用户数据字段的起点。片偏移以**8个字节**为偏移单位，这说明除了最后一个数据报外，其他分片的长度一定是8字节的整数倍

![image-20231119091958876](E:\Markdown\计网\图图\image-20231119091958876.png)

* 生存时间：占8bit，记为TTL，表示数据报在网络中可通过的路由器数的最大值（每次转发后将该数值减1）
* 协议：占8bit，指出此数据报携带的数据使用何种协议
* 首部校验和：占16bit，这个字段只检验数据报的首部，**不包括数据部分**。数据报每经过一个路由器，都要重新计算一下首部校验和。

![image-20231119092539341](E:\Markdown\计网\图图\image-20231119092539341.png)

* 源地址：占32bit，发送数据报的主机的IP地址
* 目的地址：占32bit，接收数据报的主机的IP地址

* 可变部分：长度从1字节到40字节不等

### 4.3 IP转发分组的过程

#### 4.3.1 基于分组的转发

* 发送主机首先确定目的主机是否在本网络中：将目的地址与本网络N1的子网掩码按位与，和本网络的前缀比较。若在本网络中则直接发送

* 若目的主机不在本网络中，则将该分组发送给路由器R，让R根据转发表处理该分组
* 路由器R根据转发表中的**网络前缀**进行匹配操作，寻找**最长前缀匹配**的网络地址

两种特殊的路由：

（1）主机路由：又叫做特定主机路由，是对特定目的主机的IP地址专门指明的一个路由。若目的主机的IP地址为$a.b.c.d$，则转发表中的该网络前缀为$a.b.c.d/32$，这样按位与的结果必为匹配，所以将收到的分组转发到指定的下一跳。**放在转发表的最前面**

（2）默认路由：不管分组的最终目的网络在哪里，都由指定的路由器R来处理。用特殊前缀$0.0.0.0/0$来表示默认路由

![image-20231119094712088](E:\Markdown\计网\图图\image-20231119094712088.png)

#### 4.3.2 使用二叉线索查找转发表

（1）二叉线索是一种特殊结构的树，可以快速在转发表中找到匹配的叶节点。

（2）从二叉线索的根节点自顶向下的深度最多有32层，每一层对应IP地址中的一位

（3）为了简化二叉线索的结构，可以用唯一前缀来构造二叉线索

![image-20231119095242738](E:\Markdown\计网\图图\image-20231119095242738.png)

### 4.4 网际控制报文协议ICMP

ICMP允许主机或路由器**报告差错情况**和**提供有关异常情况**的报告，ICMP是IP层的协议，位于IP数据报的数据部分

![image-20231119095528741](E:\Markdown\计网\图图\image-20231119095528741.png)

#### 4.4.1 ICMP报文的种类

![image-20231119095622946](E:\Markdown\计网\图图\image-20231119095622946.png)

![image-20231119100002091](E:\Markdown\计网\图图\image-20231119100002091.png)

不应该发送ICMP报文的几种情况：

* 对ICMP差错报告报文不再发送ICMP差错报文
* 对第一个分片的数据报片的所有后续数据报片，都不发送ICMP差错报告报文
* 对具有**多播地址**的数据报，都不发送ICMP差错报告报文
* 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报，不发送ICMP差错报告报文

ICMP询问报文：

* 回送请求和回答：由主机或路由器向一个特定的目的主机发出的询问，收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文，这种询问报文用于测试目的站是否可达，以及了解其相关状态
* 时间戳请求和回答：用于计算当前网络的往返时延

#### 4.4.2 ICMP的应用举例

* PING：用于测试两台主机间的连通性，使用了**ICMP回送请求与回送回答报文**。PING是应用层直接使用网络层ICMP的例子，没有通过运输层的TCP或UDP
* traceroute/tracert：用于跟踪一个分组从源点到终点的路径。其利用IP数据报中的TTL字段，ICMP时间超过差错报文和ICMP终点不可达差错报文实现从源点到终点的路径的跟踪

### 4.5 IPv6

IPv6将协议数据单元称为**分组**，而不是IPv4中的数据报。IPv6的地址空间从32bit扩展到了128bit

#### 4.5.1 IPv6的基本首部

IPv6首部改为8字节对齐，即首都长度必须是8字节的整数倍

![image-20231119101238281](E:\Markdown\计网\图图\image-20231119101238281.png)

IPv6数据报由两大部分组成：

* 基本首部：固定的40字节，有效字段数减少到8个
* 有效载荷：也称为净负荷，允许有0个或多个扩展首部，再后面是数据部分

![image-20231119101541857](E:\Markdown\计网\图图\image-20231119101541857.png)

基本首部的各字段：

* 版本：占4bit，指明了协议的版本，对IPv6该字段是6
* 通信量类：占8bit，这是为了区分不同的IPv6数据报的类别或优先级，和IPv4的区分服务字段的作用相似
* 流标号：占20bit，“流”是互联网络上从特定源点到特定终点（单播或多播）的一系列数据报（实时音频或视频传输），“流”经过的路径上的路由器都保证服务质量。属于同一个流的数据报都具有相同的流标号
* 有效载荷长度：占16bit，指明IPv6数据报除基本首部以外的字节数，这个字段的最大值为64KB
* 下一个首部：占8bit，相当于IPv4的协议字段或可选字段
  * 当IPv6数据报没有扩展首部时，“下一个首部”字段的值指出了基本首部后面的数据应该交付IP层上面的哪一个高层协议
  * 当出现扩展首部时，“下一个首部”字段的值就标识后面第一个扩展首部的类型
* 跳数限制：占8bit，防止数据报在网络中无限期地存在
* 源地址：发送端的IP地址
* 目的地址：接收端的IP地址

#### 4.5.2 IPv6的地址

一个IPv6数据报的目的地址可以是以下三种基本类型地址之一：

* 单播：传统的点对点通信
* 多播：数据报发送到一组计算机中的每一个
* 任播：任播的终点是一组计算机，但数据报只交付给其中的一个

IPv6将实现IPv6的主机和路由器均称为节点，一个节点可以有多个和链路相连的接口，IPv6地址是分配给节点上接口的

IPv6采用**冒号十六进制记法**：把每个16位的值用十六进制值表示，各值之间用冒号分隔

* 十六进制记法中，允许将数字前面的0省略
* 零压缩：一连串连续的零可以被一对冒号所取代，例如$FF05:0:0:0:0:0:0:B3$可以压缩为$FF05::B3$，规定任一地址中只能使用一次零压缩

* 点分十进制记法的后缀：在IPv4向IPv6转换阶段很实用，例如$0:0:0:0:0:0:128.10.2.1$，要注意的是**冒号**所分隔得每个值是16bit的值，但点分十进制每个部分的值仍是8bit

* CIDR的斜线表示法仍然可用，但取消了子网掩码

IPv6常用地址：

![image-20231119103742398](E:\Markdown\计网\图图\image-20231119103742398.png)

IPv6的单播地址划分方法有三种：

![image-20231119103908918](E:\Markdown\计网\图图\image-20231119103908918.png)

#### 4.5.3 从IPv4向IPv6过渡

方法：逐步演进，向后兼容。过度策略有两种：**双协议栈**和**隧道技术**

（1）双协议栈：使一部分主机同时装有IPv4和IPv6两种协议栈

![image-20231119104148936](E:\Markdown\计网\图图\image-20231119104148936.png)

双协议栈主机使用DNS来进行查询目的主机的IP协议类型

（2）隧道技术

![image-20231119104314469](E:\Markdown\计网\图图\image-20231119104314469.png)

#### 4.5.4 ICMPv6

ICMPv6中包含了ARP和IGMP中的功能

![image-20231119104448935](E:\Markdown\计网\图图\image-20231119104448935.png)

### 4.6 互联网的路由选择协议

路由选择协议属于**网络层控制层面**的内容

路由算法可以分为**静态路由选择策略**和**动态路由选择策略**，二者也叫做**非自适应路由选择**和**自适应路由选择**

互联网：把整个互联网分为许多较小的自治系统**AS**，采用分层次的路由选择协议

主要分为两个层次：域间路由选择和域内路由选择

对于AS而言，每一个AS对其他AS表现出的是一个**单一和一致的路由选择策略**，所以可将路由选择协议分为两大类：

* 内部网关协议IGP：在一个AS内部使用的路由选择协议，常用**RIP和OSPF**

* 外部网关协议EGP：在不同的AS之间进行路由选择，常用BGP-4

#### 4.6.1 内部网关协议RIP

RIP是一种分布式的**基于距离向量**的路由选择协议，是互联网的标准协议，其要求每一个路由器要维护从它自己到其他每一个目的网络的距离记录

RIP中“距离”的定义：路由器到直接连接的网络的距离=1，到非直接连接的网络的距离=所经过的路由器数+1。“距离”也可以称为“跳数”

RIP允许一条路径最多只能包含15个网络，因此距离等于16时相当于不可达，可见RIP只适用于小型互联网

RIP协议的三个特点：

* 仅和相邻的路由器交换信息
* 交换的信息是当前本路由器所知道的全部信息，即自己现在的路由表
* 按固定的时间间隔交换路由信息

路由表的建立：

* 路由器在刚开始工作时路由表是空的
* 然后，得到直接连接的网络的距离，之后没一个路由器之和数目有限的相邻路由器交换并更新路由信息
* 经过若干次更新后，所有的路由器都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址
* RIP协议的收敛过程较快
* RIP协议中坏消息传播得慢

**距离向量算法**：

![image-20231119110630954](E:\Markdown\计网\图图\image-20231119110630954.png)

**对（2）中第2条的解释：网络的拓扑结构可能发生了改变，必须要进行更新**

RIP报文作为**运输层用户数据报UDP**的数据部分进行传送

![image-20231119111045147](E:\Markdown\计网\图图\image-20231119111045147.png)

![image-20231119111210149](E:\Markdown\计网\图图\image-20231119111210149.png)

**RIP协议的优缺点**：

* 优点：实现简单，开销较小
* 缺点：
  * 网络规模有限，最大距离为15
  * 交换的路由信息为完整的路由表，开销较大
  * 坏消息传播得慢

#### 4.6.2 内部网关协议OSPF

使用了Dijkstra提出的最短路径算法SPF，采用分布式链路状态协议

OSPF的三个主要特点：

* 采用泛洪法，向本自治系统中的所有路由器发送信息
* 发送的信息是与本路由器相邻的所有路由器的链路状态（说明本路由器都和哪些路由器**相邻**，以及该链路的度量）
* 当链路状态发生变化或每隔一段时间，路由器才用泛洪法向所有路由器发送此信息

OSPF能够形成全网的拓扑结构图，这是RIP不能做到的。而且OSPF更新过程收敛速度快

为了使OSPF能够适用于更大的网络，将自治系统划分为不同的**区域**，每个区域都有一个32bit的区域标识符，这样采用泛洪法交换链路状态信息的范围局限于每一个区域而不是整个AS。

OSPF采用层次结构的区域划分，在上层的区域叫做主干区域，用于连通其他下层区域，主干区域的标识符规定为0.0.0.0。路由器分为多种：

* 区域边界路由器ABR，如$R_3,R_4,R_7$
* 主干路由器BR：在主干区域内的路由器，如$R_3,R_4,R_5,R_6,R_7$，一个主干路由器可以同时是区域边界路由器
* 自治系统边界路由器ASBR：和本自治系统外的其他自治系统交换路由信息

![image-20231119112836121](E:\Markdown\计网\图图\image-20231119112836121.png)

**OSPF的优缺点**：

* 优点：减少了整个网络上的通信量、减少了需要维护的状态数量
* 缺点：交换信息的种类增多了、OSPF协议很复杂

![image-20231119113100350](E:\Markdown\计网\图图\image-20231119113100350.png)

OSPF分组是作为**IP数据报的数据部分**来传送的

![image-20231119113218963](E:\Markdown\计网\图图\image-20231119113218963.png)

OSPF工作过程：

* 确定邻站可达：相邻路由器每10s要交换一次问候分组，若有40s没有收到某个相邻路由器发来的问候分组，则可认为该相邻路由器不可达
* 同步链路状态数据库：同步指不同路由器的链路状态数据库的内容是一样的，两个同步的路由器叫做完全邻接的路由器
* 更新链路状态：只要链路状态发生变化，路由器就使用链路状态更新分组，采用**可靠的泛洪法**来向全网更新链路状态。每隔一段时间，要刷新一次数据库中的链路状态

#### 4.6.3 外部网关协议BGP

略

转发和路由选择的区别：

![image-20231119114057921](E:\Markdown\计网\图图\image-20231119114057921.png)

路由器对线路上收到的分组的处理：

![image-20231119114253651](E:\Markdown\计网\图图\image-20231119114253651.png)

路由器输出端口将交换结构传送来的分组发送到线路：

![image-20231119114345922](E:\Markdown\计网\图图\image-20231119114345922.png)

交换结构：

* 通过存储器：

![image-20231119114458623](E:\Markdown\计网\图图\image-20231119114458623.png)

* 通过总线：

![image-20231119114532059](E:\Markdown\计网\图图\image-20231119114532059.png)

* 通过纵横交换结构：

![image-20231119114615535](E:\Markdown\计网\图图\image-20231119114615535.png)

### 4.7 IP多播

#### 4.7.1 IP多播的基本概念

* IP多播通过在IP多播数据报的目的地址写入多播组的标识符来实现。多播组的标识符就是IP地址中的D类地址，地址范围为224.0.0.0~239.255.255.255，每一个D类地址标识一个多播组。需要注意的是多播地址只能用于目的地址，不能用于源地址

* 多播数据报和一般的IP数据报的区别：
  * 目的地址：使用D类IP地址
  * 协议字段=2，表示使用网际组管理协议IGMP
* 多播数据报也是“尽最大努力交付”，不保证一定能够交付给多播组内的所有成员
* 对多播数据报不会产生ICMP差错报文，因此PING后面跟D类地址，不会有任何响应

#### 4.7.2 在局域网上进行硬件多播

* IANA拥有的以太网地址块的高24位为00-00-5E

* TCP/IP协议使用的以太网地址块的范围是00-00-5E-00-00-00到00-00-5E-FF-FF-FF
* IANA只拿出01-00-5E-00-00-00到01-00-5E-7F-FF-FF这$2^{23}$个地址作为以太网多播地址。或者说在48位的多播地址中，前25位都固定不变，只有后23位可以用作多播

D类地址于以太网多播地址的映射关系：

![image-20231119145508900](E:\Markdown\计网\图图\image-20231119145508900.png)

所以对于收到多播数据报的主机来说，还要在IP层对IP地址进行过滤，把不是本机要接收的数据报丢弃

#### 4.7.3 IGMP和多播路由选择协议

IP多播需要两种协议，即IGMP协议和多播路由选择协议。IGMP协议是让连接在本地局域网上的多播路由器知道本局域网上是否主机参加或退出了某个多播组，多播路由选择协议把多播数据报用最小代价传送给所有的组成员。

要注意以下几点：

* 多播转发必须动态地适应多播组成员的变化（即使此时网络拓扑并未变化）
* 多播路由器再转发多播数据报时，不能仅根据多播数据报中的目的地址，还要考虑这个多播数据报从哪里来，到哪里去
* 多播数据报可以有**没有加入多播组的主机**发出，也可以通过没有组成员的接入网络

##### 4.7.3.1 IGMP

IGMP使用IP数据报传递其报文，但它也像IP提供服务，所以要将IGMP看作整个网际协议IP的一个组成部分

IGMP工作可分为两个阶段：加入多播组、探询组成员变化情况

* 当某个主机加入多播组时，该主机像多播组的多播地址发送IGMP报文，声明自己要成为该组的成员；本地的多播路由器收到该IGMP报文后，将组成员关系转发给互联网上的其他多播路由器
* 本地多播路由器周期性地探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员；只要某个组有一个主机响应，那多播路由器就认为这个组是活跃的。否则不再将该组的成员关系转发给其他的多播路由器

IGMP采用了一些措施以避免增加大量开销：

![image-20231119151419401](E:\Markdown\计网\图图\image-20231119151419401.png)

##### 4.7.3.2 多播路由选择协议

实际上就是要找出以源主机为根节点的多播转发树，不同的多播组对应于不同的多播转发树，而对同一个多播组来说，对不同的源点也会有不同的多播转发树

例如，对M个源，N个多播组，需要M*N棵多播转发树

转发多播数据报的三种方法：

* 泛洪与剪除：适用于较小的多播组，而且所有组成员接入的局域网也是相邻接的，**采用反向路径广播RPB的策略**。RPB的要点：剪枝和嫁接
  * 剪枝：如果在多播转发树上的某个路由器发现它的下游树枝已没有多播组的成员，就把他和下游的树枝一起剪除
  * 嫁接：当某个树枝有新增加的组成员时，可以再接入到多播转发树上
* 隧道技术：

![image-20231119152315031](E:\Markdown\计网\图图\image-20231119152315031.png)

* 基于核心的发现技术

![image-20231119152502114](E:\Markdown\计网\图图\image-20231119152502114.png)

![image-20231119152514619](E:\Markdown\计网\图图\image-20231119152514619.png)

### 4.8 虚拟专用网VPN和网络地址转换NAT

#### 4.8.1 VPN

三个本地地址块：（互联网中的所有路由器对目的地址是被本地地址的数据报一律**不进行转发**）

* 10.0.0.0/8：一个A类网络
* 172.16.0.0/12：连续16个B类网络
* 192.168.0.0/16：连续256个C类网络

采用这样的本地IP地址的互联网称为专用互联网或本地互联网，专用IP地址也叫做**可重用地址**

利用共用互联网作为本机构各专用网之间的通信载体，这样的专用网又称为**虚拟专用网VPN**

用隧道技术实现虚拟专用网：

![image-20231119153336875](E:\Markdown\计网\图图\image-20231119153336875.png)

VPN类型：

* 内联网：同一个机构的内部网络所构成的VPN
* 外联网：一些机构和某些外部机构共同建立的
* 远程接入VPN：允许外部流动员工通过接入VPN建立隧道访问公司内部网络

#### 4.8.2 网络地址转换NAT

需要在专用网连接到互联网的路由器上安装NAT软件，该路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址

![image-20231119153820110](E:\Markdown\计网\图图\image-20231119153820110.png)

在内部主机与外部主机通信时，再NAT路由器上发生了两次地址转换

![image-20231119153913767](E:\Markdown\计网\图图\image-20231119153913767.png)

当NAT路由器具有n各全球IP地址时，专用网内最多可以同时有n台主机接入到互联网

<font color="red">注意：</font>通过NAT路由器的通信必须有专用网内的主机发起，因此专用网内部的主机不能充当服务器使用

#### 4.8.3 网络地址与端口号转换NAPT

NAPT可以使多台拥有本地地址的主机共用一个全球IP地址，同时和互联网上的不同主机进行通信

![image-20231119154242380](E:\Markdown\计网\图图\image-20231119154242380.png)

### 4.9 多协议标签交换MPLS

在MPLS的上层可以采用多种协议，MPLS利用面向连接技术是每个分组携带一个叫做标签的小整数，标签交换路由器用标签值检索转发表，从而实现分组的快速转发

MPLS并没有取代IP，而是作为一种IP增强技术，它有三个特点：

* 支持**面向连接**的服务质量
* 支持流量工程，平衡网络负载
* 有效地支持虚拟专用网VPN

#### 4.9.1 MPLS基本工作过程

![image-20231119154648003](E:\Markdown\计网\图图\image-20231119154648003.png)

![image-20231119154723330](E:\Markdown\计网\图图\image-20231119154723330.png)

LSR同时具有标签交换和路由选择两种功能。标签交换功能是为了快速转发，路由选择功能是为了构造转发表

![image-20231119154954670](E:\Markdown\计网\图图\image-20231119154954670.png)

![image-20231119155009213](E:\Markdown\计网\图图\image-20231119155009213.png)

![image-20231119155058237](E:\Markdown\计网\图图\image-20231119155058237.png)

注意：

* 这种“由入口LSR确定进入MPLS域后的转发路径”称为“显示路由选择”
* 与互联网中通常使用的“每一个路由器逐跳进行路由选择”有着很大的区别

#### 4.9.2 转发等价类FEC

给IP数据打标签的过程叫做分类

* 第三层分类：只使用IP首部中的源和目的IP地址等
* 大多数运营商实现了第四层分类：要检查TCP或UDP端口号
* 部分运营商实现了第五层分类：进一步检查数据报的内部并考虑其有效载荷

而划分FEC的方法不受什么限制，管理员可以自定义FEC以更好地管理网络资源，这种均衡网络负载的做法也成为流量工程

#### 4.9.3 MPLS首部的位置与格式

MPLS不要求下层的网络都使用面向连接的技术。MPLS采用封装技术，在将IP数据报封装成以太网帧之前，先要插入一个MPLS首部

![image-20231119155755194](E:\Markdown\计网\图图\image-20231119155755194.png)

![image-20231119155912505](E:\Markdown\计网\图图\image-20231119155912505.png)

### 4.10 软件定义网络SDN

SDN是一个体系结构，是一种设计、构建和管理网络的新方法



## 5. 运输层

### 5.1 运输层协议概述

#### 5.1.1 进程之间的通信

* 运输层向应用层提供通信服务，它属于面向通信部分的最高层，也是用户功能中的最底层

* 网络层为主机之间的通信提供服务，而运输层在网络层的基础上，为应用进程之间的通信提供服务
* 运输层主要有两种运输协议：面向连接的TCP和无连接的UDP

#### 5.1.2 运输层的两个主要协议

**用户数据报协议UDP**和**传输控制协议TCP**，两个对等运输实体在通信时传送的数据单位叫做**运输协议数据单元TPDU**，但在TCP/IP体系种，根据使用的协议是TCP还是UDP，分别称之为**TCP报文段**或**UDP用户数据报**

![image-20231122152301525](E:\Markdown\计网\图图\image-20231122152301525.png)

#### 5.1.3 运输层的端口

* 复用：应用层所有的应用进程都可以通过运输层再传送到IP层（网络层）
* 分用：运输层从IP层收到发送给应用进程的数据后，必须分别交付给指明的各应用进程

* 端口号：在运输层使用协议端口号，或通常简称为端口（是软件端口），用一个16位端口号进行标志

端口号分为两大类、三种类型：

![image-20231122152825294](E:\Markdown\计网\图图\image-20231122152825294.png)

* 服务器使用的端口号：0-49151
  * 熟知端口号：0-1023
  * 登记端口号：1024-49151
* 客户端使用的端口号：49152-65535

### 5.2 用户数据报协议UDP

UDP只在IP的数据报服务之上增加了很少一点的功能：复用和分用的功能以及差错检测的功能

#### 5.2.1 UDP概述

主要特点：

* **无连接**：发送数据之前不需要建立连接
* **尽最大努力交付**：不保证可靠交付
* **面向报文**：UDP一次传送和交付一个完整的报文
* **没有拥塞控制**：网络出现的拥塞不会使源主机的发送速率降低，很适合多媒体通信的要求

* 支持一对一、一对多、多对一以及多对多等交互通信
* 首部开销小：只有8个字节

#### 5.2.2 UDP的首部格式

![image-20231122154306008](E:\Markdown\计网\图图\image-20231122154306008.png)

* 源端口：在需要对方回信时选用，不需要时可用全0
* 目的端口：在终点交付报文时必须选用
* 长度：UDP用户数据报的长度，其最小值是8字节（仅有首部）
* 校验和：检测UDP用户数据报在传输中是否有错

如果接收方UDP发现收到的报文中的目的端口号不正确，则丢弃该报文，并由ICMP发送“端口不可达”差错报文给发送方

UDP用户数据报计算检验和的方法比较特殊，要在UDP用户数据报之前增加12个字节的**伪首部**

![image-20231122154759848](E:\Markdown\计网\图图\image-20231122154759848.png)

### 5.3 传输控制协议TCP概述

#### 5.3.1 TCP最主要的特点

* TCP是面向连接的运输层协议
* 每一条TCP连接只能有**两个端点**，每一条TCP连接只能是**点对点**的
* TCP提供可靠交付的服务
* TCP提供全双工通信

* TCP面向字节流：TCP中的“流”指的是流入或流出进程的字节序列，虽然应用程序和TCP的交互是一次一个数据块，但TCP将应用程序交下来的数据仅看成一连串**无结构的字节流**

  TCP不保证接收方应用程序发送的和发送方应用程序发出的数据块有对应大小的关系（例如，发送方发送了10个数据块，但接收方只用了4个数据块就把收到的字节流交付给上层的应用程序）

![image-20231122155513266](E:\Markdown\计网\图图\image-20231122155513266.png)

TCP不关心应用进程一次将多长的报文发送到TCP缓存，它会根据对方给出的窗口值和当前网络拥塞程度来决定一个报文应包含多少个字节

#### 5.3.2 TCP的连接

TCP将连接作为最基本的抽象。TCP连接的端点叫做**套接字**或**插口**。

套接字$socket=(IP地址：端口号)$，每一条TCP连接唯一地被通信两端的两个端点（即两个套接字）所确定：TCP连接::={socket1,socket2}

* 同一个IP地址可以有多个不同的TCP连接
* 同一个端口号也可以出现在多个不同的TCP连接中

### 5.4 可靠传输的工作原理

#### 5.4.1 停止等待协议

每发送完一个分组就停止发送，等待对方的确认，在收到确认后再发送下一个分组。全双工通信的双方既是发送方也是接收方

* 无差错情况：

![image-20231122173413868](E:\Markdown\计网\图图\image-20231122173413868.png)

* 出现差错：B接收M1时检测出了差错，就丢弃M1，其他什么也不做；M1在传输过程中丢失了，B什么都不知道，什么都不做

![image-20231122173554741](E:\Markdown\计网\图图\image-20231122173554741.png)

![image-20231122173622886](E:\Markdown\计网\图图\image-20231122173622886.png)

* 确认丢失

![image-20231122173758842](E:\Markdown\计网\图图\image-20231122173758842.png)

* 确认迟到

![image-20231122173921780](E:\Markdown\计网\图图\image-20231122173921780.png)

停止等待协议的要点：

（1）停止等待：发送方每次只发送一个分组，在收到确认后再发送下一个分组

（2）暂存：在发送完一个分组后，发送方必须暂存已发送的分组的副本，以备重发

（3）编号：对发送的每个分组和确认都进行编号

（4）超时重传：发送方位发送的每个分组设置一个超时计时器。若超时计时器未收到确认，发送方会自动超时重传分组

（5）超时计时器的重传时间应当比数据在分组传输二点平均往返时间更长一些，防止不必要的重传

（6）简单，但信道利用率太低

#### 5.4.2 连续ARQ协议

* 发送窗口：发送方维持一个发送窗口，位于发送窗口内的分组都可以被连续发送出去，而不需要等待对方的确认
* 发送窗口滑动：发送方每收到一个确认，就将发送窗口向前滑动一个分组的位置
* 累计确认：接收方对按序到达的最后一个分组发送确认，表示：到这个分组为止的所有分组都已经正确收到了
  * 优点：容易实现，即使确认丢失也不必重传
  * 缺点：不能及时向发送方反映出接收方已经正确收到的所有分组的信息

### 5.5 TCP报文段的首部格式

TCP报文段首部的前20个字节是固定的，后面有4n字节是根据需要而增加的选项（n是整数）。因此TCP首部的**最小长度是20字节**

![image-20231123095210375](E:\Markdown\计网\图图\image-20231123095210375.png)

* 源端口和目的端口：各占2个字节，分别写入源端口号和目的端口号

* 序号：占4字节，TCP连接中传送的数据流中的每一个字节都有一个序号，序号字段的值则指的是本报文段所发送的数据的**第一个字节**的序号。

  例如一个报文段的序号字段值为301，而携带的数据共有100字节，那表明本报文段的第一个字节的序号是301，最后一个字节的序号是400

* 确认号：占4字节，是**期望收到**对方的下一个报文段的数据的**第一个字节**的序号。

  例如，B正确收到了A发来的一个报文段，其序号字段值是501，而数据长度是200字节，所以B期望收到A的下一个数据序号是701，于是B在发送给A的确认报文段中把确认号置为701。若确认号为N，则表明到序号N-1为止的所有数据都已正确收到

* 数据偏移：占4bit，指出TCOP报文段的数据起始处距离TCP报文段的起始处有多远，实际上就是指出TCP报文段的首部长度。由于这一字段能表示的最大值为15，所以TCP首部的最大长度为60字节，即选项长度不能超过40字节

* 保留：占6bit，保留为日后使用，但目前置为0

* 六个控制位：说明本报文段的性质

  * 紧急URG：当URG=1时，表明紧急指针字段有效，告诉系统此报文段中有紧急数据应尽快传送（优先级较高）
  * 确认ACK：只有当ACK=1时，确认号字段才有效，所以在建立连接后所有传送的报文段都必须把ACK置为1
  * 推送PSH：接收方TCP在收到PSH=1的报文后，就尽快交付接收应用进程，而不再等到整个缓存都填满后再交付。这样有利于交互式通信
  * 复位RST：当RST=1时，表明TCP连接中出现严重差错，必须释放连接，然后重新建立运输连接。将RST置为1还可以用来拒绝一个非法的报文段或拒绝打开一个连接
  * 同步SYN：在连接建立时用来同步序号，当SYN=1时表示这是一个连接请求或连接接受报文。（ACK=0：连接请求报文；ACK=1：连接接受报文）
  * 终止FIN：用来释放一个连接

* 窗口：占2字节，窗口值告诉对方：从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）。窗口值经常在动态变化

* 检验和：占2字节，检验和字段检验的范围包括首部和数据这两部分，在计算检验和时要在TCP报文段的前面加上12字节的伪首部

* 紧急指针：占2字节，只有在URG=1时才有意义。它指出了紧急数据的字节数（紧急数据结束后就是普通数据）

  **注意**：即使窗口为0时也可以发送紧急数据

* 选项：长度可变，最长可达40字节。TCP最初只规定了一种选项，即最大报文段长度MSS（TCP报文段长度-TCP首部长度）

  MSS告诉对方TCP：”我的缓存能接收的报文段的数据字段的最大长度是MSS个字节“。MSS的作用在于提高网络的利用率

![image-20231123102359779](E:\Markdown\计网\图图\image-20231123102359779.png)

![image-20231123102427787](E:\Markdown\计网\图图\image-20231123102427787.png)

其余选项：

* 窗口扩大：占3字节，其中一个字节表示移位值S。新的窗口值等于TCP首部中的窗口位数从16增大到（16+S）移位值允许使用的最大值为14。窗口扩大选项可以再双方初始建立TCP连接时进行协商
* 时间戳选项：占10字节，其中最重要的2个字段是**时间戳值字段（2字节）**和**时间戳回送回答字段（2字节）**
  * 主要功能1：计算往返时间RTT，发送方在发送报文时把当前时钟的时间值放入时间戳字段，接收方在确认该报文段时把时间戳字段值复制到时间戳回送回答字段
  * 主要功能2：防止序号绕回PAWS。为了使接收方能够把新报文段和迟到很久的旧报文段区分开

### 5.6 TCP可靠传输的实现

#### 5.6.1 以字节为单位的滑动窗口

**发送窗口**：

![image-20231123151314953](E:\Markdown\计网\图图\image-20231123151314953.png)

发送窗口的后沿的变化情况有两种：**不动**（没有收到新的确认）和**前移**（收到了新的确认）

发送窗口的前沿通常是不断**向前移动**的，但也可以**不动**（没有收到新的确认，或收到了新的确认但对方通知的窗口变小了），还可能**向后收缩**（对方通知的窗口变小，强烈不赞成）

要描述一个发送窗口的状态需要三个指针：$P_1,P_2,P_3$，指针都指向字节的序号

![image-20231123152328074](E:\Markdown\计网\图图\image-20231123152328074.png)

**接收窗口**：

![image-20231123152540520](E:\Markdown\计网\图图\image-20231123152540520.png)

由于接收方只能对按序收到的最高序号给予确认，因此B发送的报文段中的确认号仍然是31

![image-20231204201643562](E:\Markdown\计网\图图\image-20231204201643562.png)

![image-20231204201713687](E:\Markdown\计网\图图\image-20231204201713687.png)

接收方确认收到后，发出下一个请求

![image-20231204201852279](E:\Markdown\计网\图图\image-20231204201852279.png)

可能存在发送方一直未收到确认，导致发送窗口被填满

![image-20231204201951473](E:\Markdown\计网\图图\image-20231204201951473.png)

**发送缓存**：发送方的应用进程将字节流写入TCP发送缓存

![image-20231204202056963](E:\Markdown\计网\图图\image-20231204202056963.png)

**接收缓存**：接收方的应用进程从TCP接收缓存中读取尚未被读取的字节

![image-20231204202159956](E:\Markdown\计网\图图\image-20231204202159956.png)

**有三点需要强调**：

* 发送窗口是根据接收窗口设置的，但在同一时刻，发送窗口并不总是和接收窗口一样大

* TCP 标准没有规定对不按序到达的数据应如何处理。通常是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程

* TCP 要求接收方必须有累积确认的功能，以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上。但接收方不应过分推迟发送确认，否则会导致发送方不必要的重传，捎带确认实际上并不经常发生

#### 5.6.2 超时重传时间的选择

超时重传时间不能太长：会使网络的空闲时间增大，降低了传输效率

超时重传时间不能太短：会引起很多报文段的不必要的重传，使网络负荷增大

TCP采用了一种自适应算法，它记录一个报文段**发出的时间**，以及收到相应的**确认的时间**，这两个时间之差就是报文段的往返时间**RTT**

加权平均往返时间$RTT_S$又称为平滑的往返时间，当第一次测量到RTT样本时，$RTT_S$值就取为所测量到RTT样本值

![image-20231204202811011](E:\Markdown\计网\图图\image-20231204202811011.png)

显然，超时重传时间RTO应略大于$RTT_S$，公式如下，其中$RTT_D$是RTT的**偏差**的加权平均值

![image-20231204203159652](E:\Markdown\计网\图图\image-20231204203159652.png)

**Karn算法**：在计算平均往返时间RTT时，只要报文段重传了，就不采用其往返时间样本

**修正的Karn算法**：

![image-20231204203506075](E:\Markdown\计网\图图\image-20231204203506075.png)

#### 5.6.3 选择确认SACK

用于解决**只重传缺少的数据而不重传已正确到达接收方的数据**的问题

![image-20231204203751691](E:\Markdown\计网\图图\image-20231204203751691.png)

### 5.7 TCP的流量控制

#### 5.7.1 利用滑动窗口实现流量控制

**流量控制**：让发送方的发送速率不要太快。使接受方来得及接收

可以利用可变窗口来简单地进行流量控制：

![image-20231204203949534](E:\Markdown\计网\图图\image-20231204203949534.png)

但可能存在死锁问题：

![image-20231204204144499](E:\Markdown\计网\图图\image-20231204204144499.png)

为了解决死锁问题，可以采用**持续计数器**

![image-20231204204251956](E:\Markdown\计网\图图\image-20231204204251956.png)

#### 5.7.2 TCP的传输效率

TCP发送报文段有三种机制：

![image-20231204204418905](E:\Markdown\计网\图图\image-20231204204418905.png)

**糊涂窗口综合征**：每次仅发送一个字节或很少几个字节的数据时，有效数据传输效率变得很低

* 发送方糊涂窗口综合征：

![image-20231204204643971](E:\Markdown\计网\图图\image-20231204204643971.png)

* 接收方糊涂窗口综合征：

![image-20231204204708260](E:\Markdown\计网\图图\image-20231204204708260.png)

解决方法：

![image-20231204204835272](E:\Markdown\计网\图图\image-20231204204835272.png)

### 5.8 TCP的拥塞控制

#### 5.8.1 拥塞控制的一般原理

**拥塞**：在某段时间内，对网络中某一资源的需求超过了该资源所能提供的可用部分，网络的性能就要变差

而且增加资源不能解决拥塞，而且还可能使网络的性能**更差**

![image-20231204205105287](E:\Markdown\计网\图图\image-20231204205105287.png)

拥塞控制和流量控制的区别：

![image-20231204205138916](E:\Markdown\计网\图图\image-20231204205138916.png)

拥塞控制的前提是**网络能够承受现有的网络负荷**，而且拥塞控制是一个很难设计的动态问题。分组的丢失是网络发生拥塞的征兆而不是原因，在很多情况下正是**拥塞控制本身**引起网络性能恶化，甚至发生死锁

拥塞控制可以分为开环控制和闭环控制两类：

![image-20231204205536616](E:\Markdown\计网\图图\image-20231204205536616.png)

![image-20231204205821437](E:\Markdown\计网\图图\image-20231204205821437.png)

![image-20231204205832926](E:\Markdown\计网\图图\image-20231204205832926.png)

![image-20231204205843446](E:\Markdown\计网\图图\image-20231204205843446.png)

#### 5.8.2 TCP的拥塞控制方法

![image-20231204210055923](E:\Markdown\计网\图图\image-20231204210055923.png)

为了简化分析，有两条假定：

* 数据是单方向传送的，对方只传送确认报文
* 接收方总是有足够大的缓存空间，因而发送窗口的大小由网络的拥塞程度来决定

![image-20231204210206403](E:\Markdown\计网\图图\image-20231204210206403.png)

TCP拥塞控制算法有四种：**慢开始、拥塞避免、快重传和快恢复**

##### 5.8.2.1 慢开始

该算法的目的是探测网络的负载能力或拥塞程度，方法为**由小到大逐渐增大拥塞窗口数值**

![image-20231204210458828](E:\Markdown\计网\图图\image-20231204210458828.png)

![image-20231204210516465](E:\Markdown\计网\图图\image-20231204210516465.png)

![image-20231204210816533](E:\Markdown\计网\图图\image-20231204210816533.png)

传输轮次：一个传输轮次所经历的时间其实就是往返时间RTT，传输轮次强调：**把拥塞窗口 cwnd 所允许发送的报文段都连续发送出去，并收到了对已发送的最后一个字节的确认**

当cwnd达到慢开始门限ssthresh时，就开始使用拥塞避免算法

##### 5.8.2.2 拥塞避免算法

目的是让拥塞窗口cwnd缓慢地增大，避免出现拥塞。每经过一个往返时间RTT，无论在此期间收到了多少确认，发送方的拥塞窗口只加1，因此也被称作“加法增大AI”

但要注意这并不能完全避免拥塞，而是让拥塞窗口增长的缓慢些，使网络不容易出现拥塞

当网络出现拥塞时：

![image-20231204211317497](E:\Markdown\计网\图图\image-20231204211317497.png)

![image-20231204211335750](E:\Markdown\计网\图图\image-20231204211335750.png)

当发送方连续收到3个对同一报文段的重复确认时（记为3-ACK），发送方改为执行**快重传**和**快恢复**算法

##### 5.8.2.3 快重传算法

目的是让发送方尽早知道发生了个别报文段的丢失，快重传算法要求接收方立即发送确认，即使收到了失序的报文段，也要立即发出对已收到的报文段的重复确认

![image-20231204212115923](E:\Markdown\计网\图图\image-20231204212115923.png)

##### 5.8.2.4 快恢复算法

![image-20231204212159004](E:\Markdown\计网\图图\image-20231204212159004.png)

因此，TCP拥塞控制流程图如下：

![image-20231204212318903](E:\Markdown\计网\图图\image-20231204212318903.png)

#### 5.8.3 主动队列管理AQM

对TCP拥塞控制影响最大的就是路由器的**分组丢弃策略**

* 先进先出FIFO+尾部丢弃策略

**主动队列管理**：不等到路由器的队列长度已经达到最大值时才不得不丢弃后面到达的分组，而是在队列长度达到**某个值得警惕的数值时**，就主动丢弃到达的分组

![image-20231206172051390](E:\Markdown\计网\图图\image-20231206172051390.png)

![image-20231206172114426](E:\Markdown\计网\图图\image-20231206172114426.png)

### 5.9 TCP的运输连接管理

TCP连接有三个阶段：连接建立、数据传送和连接释放

#### 5.9.1 TCP的连接建立

采用三报文握手

![image-20231206172258027](E:\Markdown\计网\图图\image-20231206172258027.png)

![image-20231206172313283](E:\Markdown\计网\图图\image-20231206172313283.png)

![image-20231206172333432](E:\Markdown\计网\图图\image-20231206172333432.png)

![image-20231206172356726](E:\Markdown\计网\图图\image-20231206172356726.png)

![image-20231206172419598](E:\Markdown\计网\图图\image-20231206172419598.png)

总结：

![image-20231206172519894](E:\Markdown\计网\图图\image-20231206172519894.png)

#### 5.9.2 TCP的连接释放

四报文握手：

![image-20231206172616974](E:\Markdown\计网\图图\image-20231206172616974.png)

![image-20231206172632441](E:\Markdown\计网\图图\image-20231206172632441.png)

![image-20231206172657745](E:\Markdown\计网\图图\image-20231206172657745.png)

![image-20231206172711233](E:\Markdown\计网\图图\image-20231206172711233.png)

总结：

![image-20231206172738908](E:\Markdown\计网\图图\image-20231206172738908.png)

#### 5.9.3 2MSL时间

* 第一，保证发送的最后一个ACK报文能够到达B
* 第二，防止“已失效的连接请求报文段”出现在本连接中

## 6. 应用层

### 6.1 应用层概述

精确定义不同主机中的多个应用进程之间的通信规则

### 6.2 域名系统DNS

#### 6.2.1 概述

域名系统DNS将域名转换为IP地址。域名采用**层次树状结构**的命名方法，DNS是一个联机**分布式数据库系统**，采用客户服务器方式。

域名到IP地址的解析是由若干个**域名服务器程序**共同完成，运行这些程序的机器称为域名服务器

![image-20231212110423203](E:\Markdown\计网\图图\image-20231212110423203.png)

#### 6.2.2 互联网的域名结构

任何一个连接在互联网上的主机或路由器，都有一个唯一的层次结构的名字，即域名。这里的域还可以继续被划分为**子域**，子域还可以被继续划分为子域

![image-20231212110656217](E:\Markdown\计网\图图\image-20231212110656217.png)

域名只是个逻辑概念，并不代表计算机所在的物理地点。

**顶级域名**：原先的顶级域名分为三大类

* 国家顶级域名：如cn表示中国、us表示美国、uk表示英国等
* 通用顶级域名：com（公司企业）、net（网络服务机构）、org（非营利性组织）等
* 基础结构域名：只有一个，即arpa，用于反向域名解析，又称为**反向域名**

目前可以注册新的顶级域名

**二级域名**：在国家顶级域名下注册的二级域名均由国家自行确定

![image-20231212111603095](E:\Markdown\计网\图图\image-20231212111603095.png)

#### 6.2.3 域名服务器

实现域名系统使用分布在各地的**域名服务器**，一个服务器所负责管辖的范围叫做**区**

一个区中的所有节点必须是能够联通的，每个区设置相应的**权限域名服务器**，用来保存该区中的所有主机的域名到IP地址的映射。

需要注意的是区是DNS服务器实际管辖的范围，区可能小于等于域，但一定不能大于域

![image-20231212112020386](E:\Markdown\计网\图图\image-20231212112020386.png)

* 根域名服务器：是最高层次的域名服务器，所有根域名服务器都知道所有顶级域名服务器的域名和IP地址。**所有本地域名服务器**若要对互联网上任何一个域名进行解析，如果自己无法完成，首先求助于**根域名服务器**

  根域名服务器共有**13套**装置。根域名服务器采用**任播**技术

![image-20231218102706825](E:\Markdown\计网\图图\image-20231218102706825.png)

* 顶级域名服务器：负责管理在该顶级域名服务器注册的所有**二级域名**，当收到DNS查询请求时就给出相应的回答（可能是最后的结果，也可能是下一步应当找的域名服务器的IP地址）
* 权限域名服务器：负责一个区的域名服务器
* 本地域名服务器：当一个主机发出DNS查询请求时，该查询请求报文就发送给本地域名服务器。本地域名服务器也称为**默认域名服务器**

#### 6.2.4 域名的解析过程

![image-20231218103040003](E:\Markdown\计网\图图\image-20231218103040003.png)

![image-20231218103133138](E:\Markdown\计网\图图\image-20231218103133138.png)

![image-20231218103148463](E:\Markdown\计网\图图\image-20231218103148463.png)

#### 6.2.5 高速缓存

也称为高速缓存域名服务器，存放**最近用过的域名**以及从何处获得域名映射信息的记录。可以大大减轻根域名服务器的负荷，域名服务器应为每项内容设置**计时器**，并处理超过合理时间的项

### 6.3 文件传送协议

FTP是互联网上使用的最广泛的文件传送协议，是文件共享协议的一个大类

文件共享协议分为：

* 文件传送协议：FTP、TFTP等，要复制整个文件并对文件副本进行访问
* 联机访问协议：NFS等，允许同时对一个文件进行存取，由操作系统负责

#### 6.3.1 FTP介绍

FTP只提供文件传送的一些基本服务，它使用TCP可靠的运输服务。**主要功能**是减少或消除不同操作系统下处理文件的不兼容性

使用**客户/服务器方式**，一个FTP服务器进程可同时为多个客户进程提供服务

![image-20231218103931510](E:\Markdown\计网\图图\image-20231218103931510.png)

#### 6.3.2 NFS介绍

NFS并非对所有的数据传输都是最佳的：**仅能访问副本**。NFS允许应用进程打开一个远程文件，并在文件的某一个特定的位置上开始读写数据，NFS使用户只复制一个大文件中的一个很小的片段而不需要复制整个大文件。**NFS**在网络上传送的只是少量的修改数据

#### 6.3.3 TFTP介绍

TFTP使用客户/服务器方式和**UDP数据报**，因此TFTP需要有自己的差错改正机制。TFTP只支持文件传输，不支持交互

![image-20231218104326350](E:\Markdown\计网\图图\image-20231218104326350.png)

TFTP的工作很像停止等待协议，发送完一个文件块后要等待对方的确认，收到文件块后要发送确认

![image-20231218104501824](E:\Markdown\计网\图图\image-20231218104501824.png)

### 6.4 远程终端协议TELNET

TELNET是一个简单的远程终端协议，是互联网的正式标准，允许用户在其所在地通过TCP登录到远地的另一台主机上。TELNET服务是**透明的**，又称为**终端仿真协议**

TELNET使用客户/服务器方式，在本地系统运行客户进程，而在远地主机则运行服务器进程

### 6.5 万维网WWW

万维网用链接的方法能非常方便地从互联网上的一个站点访问另一个站点

![image-20231218105239957](E:\Markdown\计网\图图\image-20231218105239957.png)

万维网是分布式超媒体系统，是超文本系统的扩充。

![image-20231218110116044](E:\Markdown\计网\图图\image-20231218110116044.png)

#### 6.5.1 统一资源定位符URL

标志分布在互联网上的文档，使每一个文档在互联网的范围内具有唯一的标识符URL

![image-20231218110838766](E:\Markdown\计网\图图\image-20231218110838766.png)

端口字段可以是域名，也可以是IP地址

#### 6.5.2 超文本传送协议HTTP

HTTP是面向事务的应用层协议，使用TCP进行可靠的传送，是万维网上能够可靠的交换文件的重要基础

![image-20231218111735040](E:\Markdown\计网\图图\image-20231218111735040.png)

HTTP使用了面向连接的TCP作为运输层协议，但HTTP协议本身的无连接的。HTTP是无状态的，简化了服务器的设计

![image-20231218111923561](E:\Markdown\计网\图图\image-20231218111923561.png)

* HTTP/1.0：缺点是每请求一个文档就要有两倍RTT的开销，客户每一次建立新的TCP连接都要分配缓存和变量，这种非持续连接使服务器的负担很重
* HTTP/1.1：使用持续连接，服务器在发送响应后仍在一段时间内保持这条连接。有两种工作方式：

非流水线方式：

![image-20231218112239151](E:\Markdown\计网\图图\image-20231218112239151.png)

流水线方式：

![image-20231218112420629](E:\Markdown\计网\图图\image-20231218112420629.png)

* HTTP/2：服务器可以并行发回响应，允许客户复用TCP连接进行多个请求

**HTTP的报文结构**：

![image-20231218112748447](E:\Markdown\计网\图图\image-20231218112748447.png)

* 请求报文：

![image-20231218112852903](E:\Markdown\计网\图图\image-20231218112852903.png)

* 响应报文：

![image-20231218112935456](E:\Markdown\计网\图图\image-20231218112935456.png)

**1xx**表示通知信息，如请求收到了或正在进行处理；**2xx**表示成功，如接受或知道了；**3xx**表示重定向，表示要完成请求还必须采取进一步的行动；**4xx**表示客户的差错，如请求中有错误的语法或不能完成；**5xx**表示服务器的差错，如服务器失效无法完成请求

**Cookie**：万维网使用Cookie追踪在HTTP服务器和客户之间传递的状态信息

**文档分类**：

![image-20231218113333883](E:\Markdown\计网\图图\image-20231218113333883.png)

#### 6.5.3 代理服务器

代理服务器又称为**万维网高速缓存**，它代表浏览器发出HTTP请求，使用高速缓存可以减少访问互联网服务器的时延

#### 6.5.4 HTML

略

#### 6.5.5 CGI

通用网关接口CGI：定义动态文档如何创建，输入数据应如何提供给应用程序，以及输出结果应如何使用的一种标准

CGI标准所定义的规则对其他任何语言都是通用的，CGI程序的作用和网关相似

#### 6.5.6 万维网的信息检索系统

![image-20231218113621449](E:\Markdown\计网\图图\image-20231218113621449.png)

* 垂直搜索引擎：针对某一特定领域、特定人群或某一特定需求提供搜索服务
* 元搜索引擎：把用户提交的检索请求发送到多个独立的搜索引擎上去搜索，并把检索结果集中统一处理，以统一的格式提供给用户，因此是**搜索引擎之上的搜索引擎**

### 6.6 电子邮件

简单邮件发送协议：SMTP   通用互联网邮件扩充：MIME  邮件读取协议：POP3和IMAP

SMTP、POP3和IMAP都使用TCP连接可靠地传送邮件

电子邮件系统有三个主要构件：

![image-20231218140537455](E:\Markdown\计网\图图\image-20231218140537455.png)

#### 6.6.1 电子邮件的组成

电子邮件由信封和内容两部分组成，电子邮件的传输程序根据邮件信封上的信息来传送邮件，用户在从自己的邮箱中读取邮件时才能见到邮件的内容

* 电子邮件地址的格式：

![image-20231218141002542](E:\Markdown\计网\图图\image-20231218141002542.png)

#### 6.6.2 简单邮件传送协议SMTP

SMTP规定了在两个相互通信的SMTP进程之交换信息的方法，SMTP使用客户服务器方式、SMTP基于TCP实现客户与服务器的通信

SMTP是一个**基于文本**的协议，SMTP客户端与服务器之间采用**命令-相应**方式进行交互

SMTP通信的三个阶段：

* 连接建立：连接是在发送主机的SMTP客户和接收主机的SMTP服务器之间建立的，SMTP不使用中间的邮件服务器
* 邮件传送
* 连接释放：邮件发送完毕后，SMTP应释放TCP连接

#### 6.6.3 邮件读取协议POP3和IMAP

POP3：邮局协议第3个版本，POP3服务器会删除被用户读取了的邮件

IMAP：网际报文存取协议，是一个**联机**协议

![image-20231218141626477](E:\Markdown\计网\图图\image-20231218141626477.png)

![image-20231218141641339](E:\Markdown\计网\图图\image-20231218141641339.png)

#### 6.6.4 基于万维网的电子邮件

![image-20231218141808183](E:\Markdown\计网\图图\image-20231218141808183.png)

#### 6.6.5 通用互联网邮件扩充MIME

SMTP的缺点：不能传送可执行文件或其他的二进制对象；限于传送7位的ASCII码，无法传送非ASCII编码的信息；服务器会拒绝超过一定长度的邮件

![image-20231218141949047](E:\Markdown\计网\图图\image-20231218141949047.png)

### 6.7 动态主机配置协议DHCP

连接到互联网的计算机的协议软件需要正确配置的参数包括：IP地址、子网掩码、默认路由器的IP地址、域名服务器的IP地址

DHCP给运行服务器软件、且位置固定的计算机指派一个**永久**地址，给运行客户端软件的计算机分配一个临时地址

DHCP基于**UDP**工作

![image-20231218142306522](E:\Markdown\计网\图图\image-20231218142306522.png)

DHCP中继代理：DHCP中继代理收到主机广播发送的发现报文后，就以**单播**方式向DHCP服务器转发此报文，并等待其回答；收到DHCP服务器回答的提供报文后，DHCP中继代理再将其发回给主机

![image-20231218142526735](E:\Markdown\计网\图图\image-20231218142526735.png)

### 6.8 简单网络管理协议SNMP

在网络管理中，角色分为**管理程序**和**被管设备**，且一个被管设备中可能有多个被管对象。被管设备有时可称为网络元素或网元

在每一个被管设备中都要运行一个程序，以便和管理站中的管理程序进行通信。这些程序叫做**网络管理代理程序**，简称为代理

**网管协议本身不管理网络**

#### 6.8.1 SNMP概述

SNMP按照客户服务器方式工作，管理程序运行**SNMP客户程序**，代理程序运行**SNMP服务器程序**

SNMP的主要思想是**尽可能简单**，整个系统必须有一个管理站。若网络元素使用的不是SNMP而是另一种网络管理协议，SNMP协议就无法控制该网络元素，这时可使用**委托代理**

SNMP的网络管理由三个部分组成：SNMP本身、管理信息结构SMI、管理信息库MIB

SNMP定义了管理站和代理之间所交换的**分组格式**，所交换的分组包含各代理中的对象名及其状态，SNMP负责读取和改变这些数值

#### 6.8.2 管理信息结构SMI

SMI定义了命名对象和定义对象类型的**通用规则**，以及把对象和对象的值进行编码的规则，以确保网络管理数据的语法和语义的**无二义性**

![image-20231220141327553](E:\Markdown\计网\图图\image-20231220141327553.png)

SMI中所有的MIB变量必须使用**ASN.1**来定义

SMI的数据分为**类型**和**值**两个部分，SMI的数据类型分为**简单类型**和**结构化类型**两大类

SMI使用ASN.1制定的BER进行数据的编码，BER使用TLV方法进行编码

![image-20231220141601073](E:\Markdown\计网\图图\image-20231220141601073.png)

* T字段占一个字节，分为3部分：类别(2bit)、格式(1bit)、编号(5bit)
* L字段分为两种情况

![image-20231220141712478](E:\Markdown\计网\图图\image-20231220141712478.png)

* V字段可以嵌套其他数据元素的TLV字段

#### 6.8.3 管理信息库MIB

被管对象必须维持可供管理程序读写的若干控制和状态信息，这些信息总称为管理信息库MIB

**只有在MIB中的对象才是SNMP所能够管理的**

#### 6.8.4 SNMP的协议数据单元和报文

SNMP的操作只有两种基本的管理功能：

* ”读“操作：用get报文来检测各被管对象的状况
* ”写“操作：用set报文来改变各被管对象的状况

SNMP的这些功能通过**探询**操作来实现

![image-20231220142119844](E:\Markdown\计网\图图\image-20231220142119844.png)

为解决探询的问题，同时使用陷阱机制

![image-20231220142159084](E:\Markdown\计网\图图\image-20231220142159084.png)

SNMP使用无连接的UDP

* 运行代理程序的服务器段用UDP熟知端口161接收get或set报文，发送响应报文。与熟知端口通信的客户端使用临时端口
* 运行管理程序的客户端则使用UDP熟知端口162来接收来自各代理的trap报文

![image-20231220142409688](E:\Markdown\计网\图图\image-20231220142409688.png)

### 6.9 应用进程跨越网络的通信

![image-20231220142456223](E:\Markdown\计网\图图\image-20231220142456223.png)

应用进程调用应用编程接口API，将应用进程的控制权和操作系统的控制权进行转换

![image-20231220142639979](E:\Markdown\计网\图图\image-20231220142639979.png)

### 6.10 P2P应用

#### 6.10.1 Napster

Napster将所有音乐文件的索引信息都集中存放在Napster的目录服务器中

![image-20231220142822583](E:\Markdown\计网\图图\image-20231220142822583.png)

集中式目录服务器的可靠性差，并且会成为性能的瓶颈

#### 6.10.2 Gnutella

采用全分布方法定位内容，其与Napster最大的区别在于：**不使用集中式的目录服务器，而是使用泛洪法在大量Gnutella用户之间进行查询**

![image-20231220143013959](E:\Markdown\计网\图图\image-20231220143013959.png)

![image-20231220143036856](E:\Markdown\计网\图图\image-20231220143036856.png)

![image-20231220143054273](E:\Markdown\计网\图图\image-20231220143054273.png)

![image-20231220151005464](E:\Markdown\计网\图图\image-20231220151005464.png)

![image-20231220151021912](E:\Markdown\计网\图图\image-20231220151021912.png)

#### 6.10.3 分布式散列表DHT

![image-20231220143213138](E:\Markdown\计网\图图\image-20231220143213138.png)
